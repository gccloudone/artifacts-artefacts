name: Calculate Usage

on:
  schedule:
    - cron: '0 4 * * *'   # daily at 04:00 UTC
  workflow_dispatch:

jobs:
  count-and-chart:
    runs-on: ubuntu-latest

    steps:
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install npm dependencies
        run: |
          npm install chartjs-node-canvas fs-extra

      - name: Fetch and record count (pure Bash + jq)
        id: query
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          SEARCH_STRING='JF_URL: https://artifacts-artefacts.devops.cloud-nuage.canada.ca'
          # URLâ€‘encode the snippet
          QUERY=$(printf '%s' "$SEARCH_STRING" | jq -s -R -r @uri)

          PAGE=1
          rm -f all_repos.txt
          touch all_repos.txt

          while :; do
            RESPONSE=$(curl -s \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/search/code?q=$QUERY+path:.github/workflows+extension:ya?ml&per_page=100&page=$PAGE")

            echo "$RESPONSE" \
              | jq -r '.items[]?.repository.full_name' \
              >> all_repos.txt

            COUNT_PAGE=$(echo "$RESPONSE" | jq '.items | length')
            if [ "$COUNT_PAGE" -lt 100 ]; then
              break
            fi
            ((PAGE++))
          done

